dist: xenial
sudo: "required"

language: "go"

go:
    - 1.9.x

env:
  - BUILD_TYPE=Tests
  - BUILD_TYPE=Debian
  - BUILD_TYPE=Contracts
#  - BUILD_TYPE=Coverage

services:
    - "docker"

before_install:
  - sudo apt-get update
  - sudo apt-get install debhelper devscripts fakeroot dh-systemd ocl-icd-opencl-dev libnl-3-dev libnl-route-3-dev btrfs-tools -y

install:
  - git submodule update

script:
    - go get github.com/golang/mock/gomock
    - go get github.com/golang/mock/mockgen
    - |
      case "${BUILD_TYPE}" in
        Tests)
          # make all
          echo "Launch BTRFS tests"
          go test -v -c  github.com/sonm-io/core/insonmnia/worker/storagequota/btrfs -o ./btrfs.test
          LOOP_DEVICE=$(sudo losetup -f)
          sudo dd if=/dev/zero of=/btrfsfile bs=1024000 count=200
          sudo losetup $LOOP_DEVICE /btrfsfile
          sudo mkfs.btrfs /btrfsfile
          sudo mkdir /btrfsplayground
          sudo mount -t btrfs $LOOP_DEVICE /btrfsplayground
          sudo BTRFS_PLAYGROUND_PATH=/btrfsplayground ./btrfs.test -test.v
          ;;
        Contracts)
          make contracts
          ;;
        Debian)
          GO=$(which go) make deb
          ;;
        Coverage)
          make mock
          make coverage;
          bash <(curl -s https://codecov.io/bash);
          ;;
        *)
          echo "Unknown BUILD_TYPE value"
          exit 1
      esac
