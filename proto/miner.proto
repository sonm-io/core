syntax = "proto3";

import "insonmnia.proto";
import "capabilities.proto";

package sonm;

service Miner {
    // Ping checks Miner availability for Rub
    rpc Ping (EmptyRequest) returns (PingReply) {}
    // Handshake returns miner's hardware and network capabilities
    rpc Handshake (M.HandshakeRequest) returns (M.HandshakeReply) {}
    // Status returns Miner status
    rpc Status (EmptyRequest) returns (MinerStatusReply) {}

    // TaskXXX operates with task on some miner
    rpc TaskStart (M.TaskStartRequest) returns (M.TaskStartReply) {}
    rpc TaskStop (TaskStopRequest) returns (EmptyReply) {}
    rpc TasksStatus (stream EmptyRequest) returns (stream TaskDetailsMapReply) {}
    rpc TaskDetails (TaskDetailsRequest) returns (TaskDetailsReply) {}
    rpc TaskLogs (TaskLogsRequest) returns (stream TaskLogsChunk) {}
}

message M {
    message HandshakeRequest {
        string hub = 1;
    }

    message HandshakeReply {
        string miner = 1;
        Capabilities capabilities = 2;
        NATType natType = 3;
    }

    message TaskStartRequest {
        string id = 1;
        string registry = 2;
        string image = 3;
        string auth = 4;
        ContainerRestartPolicy restartPolicy = 5;
        TaskResourcesRestrictions resources = 6;
        string PublicKeyData = 7;
    }

    message TaskStartReply {
        string container = 1;
        message port {
            string IP = 1;
            string port = 2;
        }
        map<string, port> Ports = 2;
    }
}

enum NATType {
    NONE = 0;
    BLOCKED = 1;
    FULL = 2;
    SYMMETRIC = 3;
    RESTRICTED = 4;
    PORT_RESTRICTED = 5;
    SYMMETRIC_UDP_FIREWALL = 6;
    UNKNOWN = 7;
}
